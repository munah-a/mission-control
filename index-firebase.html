<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mission Control - Firebase Edition</title>
    <style>
        :root {
            --bg-primary: #0d0d0d;
            --bg-secondary: #1a1a1a;
            --bg-card: #262626;
            --bg-modal: #1f1f1f;
            --text-primary: #ffffff;
            --text-secondary: #a0a0a0;
            --accent-blue: #3b82f6;
            --accent-green: #10b981;
            --accent-yellow: #f59e0b;
            --accent-red: #ef4444;
            --accent-purple: #8b5cf6;
            --border: #333333;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
        }

        /* Header */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 2rem;
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 2rem;
        }

        .logo {
            font-size: 1.25rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .nav-tabs {
            display: flex;
            gap: 0.5rem;
        }

        .nav-tab {
            padding: 0.5rem 1rem;
            border-radius: 6px;
            cursor: pointer;
            color: var(--text-secondary);
            transition: all 0.2s;
        }

        .nav-tab.active {
            background: var(--bg-card);
            color: var(--text-primary);
        }

        .nav-tab:hover {
            background: var(--bg-card);
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .btn {
            padding: 0.5rem 1rem;
            border-radius: 6px;
            border: none;
            cursor: pointer;
            font-size: 0.875rem;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn-primary {
            background: var(--accent-blue);
            color: white;
        }

        .btn-primary:hover {
            background: #2563eb;
        }

        .btn-secondary {
            background: var(--bg-card);
            color: var(--text-primary);
            border: 1px solid var(--border);
        }

        .btn-secondary:hover {
            background: var(--border);
        }

        .btn-google {
            background: #4285f4;
            color: white;
        }

        .btn-google:hover {
            background: #3367d6;
        }

        .btn-danger {
            background: var(--accent-red);
            color: white;
        }

        .btn-small {
            padding: 0.375rem 0.75rem;
            font-size: 0.75rem;
        }

        .sync-indicator {
            display: inline-flex;
            align-items: center;
            gap: 0.375rem;
            padding: 0.375rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 500;
        }

        .sync-indicator::before {
            content: '';
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: currentColor;
        }

        .sync-indicator.synced {
            background: rgba(16, 185, 129, 0.2);
            color: var(--accent-green);
        }

        .sync-indicator.syncing {
            background: rgba(59, 130, 246, 0.2);
            color: var(--accent-blue);
            animation: pulse 1s infinite;
        }

        .sync-indicator.offline {
            background: rgba(245, 158, 11, 0.2);
            color: var(--accent-yellow);
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* User Profile */
        .user-profile {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.375rem 0.75rem;
            background: var(--bg-card);
            border-radius: 6px;
            border: 1px solid var(--border);
        }

        .user-avatar {
            width: 28px;
            height: 28px;
            border-radius: 50%;
        }

        .user-name {
            font-size: 0.875rem;
            font-weight: 500;
        }

        .user-logout {
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 0.75rem;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            transition: all 0.2s;
        }

        .user-logout:hover {
            color: var(--accent-red);
            background: rgba(239, 68, 68, 0.1);
        }

        /* Stats Bar */
        .stats-bar {
            display: flex;
            gap: 2rem;
            padding: 1rem 2rem;
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border);
        }

        .stat {
            display: flex;
            align-items: baseline;
            gap: 0.5rem;
        }

        .stat-value {
            font-size: 1.5rem;
            font-weight: 600;
        }

        .stat-label {
            color: var(--text-secondary);
            font-size: 0.875rem;
        }

        .stat-highlight {
            color: var(--accent-green);
        }

        /* Filters */
        .filters {
            display: flex;
            gap: 0.5rem;
            padding: 1rem 2rem;
            flex-wrap: wrap;
        }

        .filter-btn {
            padding: 0.375rem 0.75rem;
            border-radius: 20px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            color: var(--text-secondary);
            font-size: 0.875rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .filter-btn:hover {
            border-color: var(--accent-blue);
        }

        .filter-btn.active {
            background: var(--accent-blue);
            border-color: var(--accent-blue);
            color: white;
        }

        /* Main Layout */
        .main {
            display: flex;
            height: calc(100vh - 180px);
            overflow: hidden;
        }

        /* Kanban Board */
        .kanban {
            flex: 1;
            display: flex;
            gap: 1rem;
            padding: 1rem 2rem;
            overflow-x: auto;
            overflow-y: hidden;
            align-items: stretch;
            min-width: 0;
        }

        .column {
            min-width: 300px;
            max-width: 350px;
            flex-shrink: 0;
            display: flex;
            flex-direction: column;
        }

        .column-header {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.75rem;
            margin-bottom: 0.75rem;
        }

        .column-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }

        .column-dot.permanent { background: var(--accent-purple); }
        .column-dot.backlog { background: var(--accent-yellow); }
        .column-dot.in-progress { background: var(--accent-blue); }
        .column-dot.review { background: var(--accent-green); }
        .column-dot.done { background: #6b7280; }

        .column-title {
            font-weight: 500;
        }

        .column-count {
            color: var(--text-secondary);
            font-size: 0.875rem;
        }

        .column-add {
            margin-left: auto;
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 1.25rem;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
            transition: all 0.2s;
        }

        .column-add:hover {
            background: var(--bg-card);
            color: var(--accent-blue);
        }

        .column-tasks {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
            flex: 1;
            padding-bottom: 1rem;
            align-items: stretch;
            min-height: 100px;
        }

        /* Task Card */
        .task-card {
            background: var(--bg-card);
            border-radius: 8px;
            padding: 1rem;
            cursor: pointer;
            border: 1px solid transparent;
            transition: transform 0.2s, opacity 0.3s;
        }

        .task-card:hover {
            border-color: var(--border);
            transform: translateY(-2px);
        }

        .task-card.priority-high {
            border-left: 3px solid var(--accent-red);
        }

        .task-card.priority-medium {
            border-left: 3px solid var(--accent-yellow);
        }

        .task-card[draggable="true"] {
            cursor: grab;
        }

        .task-card.dragging {
            opacity: 0.4;
            cursor: grabbing;
            transform: scale(0.95) rotate(2deg);
        }

        .column-tasks.drag-over {
            background: rgba(59, 130, 246, 0.05);
            border-radius: 8px;
        }

        .task-card.make-space-above {
            margin-top: 60px;
        }

        .task-title {
            font-weight: 500;
            margin-bottom: 0.5rem;
            display: flex;
            align-items: flex-start;
            gap: 0.5rem;
        }

        .task-title-text {
            flex: 1;
        }

        .task-description {
            color: var(--text-secondary);
            font-size: 0.875rem;
            margin-bottom: 0.75rem;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
            max-height: 2.8em;
            line-height: 1.4;
            white-space: pre-line;
        }

        .task-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 0.5rem;
        }

        .task-tags {
            display: flex;
            gap: 0.375rem;
            flex-wrap: wrap;
        }

        .task-tag {
            padding: 0.125rem 0.5rem;
            border-radius: 4px;
            font-size: 0.75rem;
            background: var(--bg-secondary);
        }

        .task-subtasks {
            margin-top: 0.75rem;
            padding-top: 0.75rem;
            border-top: 1px solid var(--border);
        }

        .subtask-progress {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.75rem;
            color: var(--text-secondary);
        }

        .progress-bar {
            flex: 1;
            height: 4px;
            background: var(--bg-secondary);
            border-radius: 2px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: var(--accent-green);
            transition: width 0.3s;
        }

        .task-actions {
            display: flex;
            gap: 0.5rem;
            margin-top: 0.75rem;
            padding-top: 0.75rem;
            border-top: 1px solid var(--border);
        }

        .task-action-btn {
            flex: 1;
            padding: 0.375rem 0.5rem;
            border: none;
            border-radius: 4px;
            font-size: 0.75rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .task-action-btn.done {
            background: rgba(16, 185, 129, 0.2);
            color: var(--accent-green);
        }

        .task-action-btn.done:hover {
            background: rgba(16, 185, 129, 0.4);
        }

        .task-action-btn.backlog {
            background: rgba(245, 158, 11, 0.2);
            color: var(--accent-yellow);
        }

        .task-action-btn.backlog:hover {
            background: rgba(245, 158, 11, 0.4);
        }

        /* Comment indicator */
        .task-comment-indicator {
            display: flex;
            align-items: center;
            gap: 4px;
            color: var(--text-secondary);
            font-size: 0.75rem;
            flex-shrink: 0;
        }

        /* Activity Feed */
        .activity {
            width: 320px;
            background: var(--bg-secondary);
            border-left: 1px solid var(--border);
            padding: 1rem;
            overflow-y: auto;
            transition: all 0.3s ease;
        }

        .activity.collapsed {
            width: 0;
            padding: 0;
            border-left: none;
            overflow: hidden;
        }

        .activity-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: 600;
            margin-bottom: 1rem;
            color: var(--text-secondary);
            font-size: 0.875rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .activity-toggle {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 4px;
            cursor: pointer;
            color: var(--text-secondary);
            font-size: 0.875rem;
            padding: 0.25rem 0.5rem;
        }

        .activity-list {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .activity-item {
            display: flex;
            gap: 0.75rem;
            font-size: 0.875rem;
        }

        .activity-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-top: 0.375rem;
            flex-shrink: 0;
        }

        .activity-dot.created { background: var(--accent-green); }
        .activity-dot.moved { background: var(--accent-blue); }
        .activity-dot.completed { background: var(--accent-purple); }

        .activity-content {
            flex: 1;
        }

        .activity-actor {
            font-weight: 500;
        }

        .activity-action {
            color: var(--text-secondary);
        }

        .activity-task {
            color: var(--accent-blue);
        }

        .activity-time {
            color: var(--text-secondary);
            font-size: 0.75rem;
            margin-top: 0.25rem;
        }

        /* Empty State */
        .empty-state {
            color: var(--text-secondary);
            text-align: center;
            padding: 2rem;
            font-size: 0.875rem;
        }

        /* Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal-overlay.visible {
            display: flex;
        }

        .modal {
            background: var(--bg-modal);
            border-radius: 12px;
            padding: 2rem;
            max-width: 500px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            border: 1px solid var(--border);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .modal-title {
            font-size: 1.25rem;
            font-weight: 600;
        }

        .modal-close {
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 1.5rem;
            cursor: pointer;
            padding: 0.25rem;
            line-height: 1;
        }

        .modal-close:hover {
            color: var(--text-primary);
        }

        .modal-body {
            margin-bottom: 1.5rem;
        }

        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 0.75rem;
        }

        /* Form Elements */
        .form-group {
            margin-bottom: 1.25rem;
        }

        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            font-size: 0.875rem;
        }

        .form-input {
            width: 100%;
            padding: 0.75rem;
            border-radius: 6px;
            border: 1px solid var(--border);
            background: var(--bg-card);
            color: var(--text-primary);
            font-size: 0.875rem;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--accent-blue);
        }

        .form-hint {
            margin-top: 0.5rem;
            font-size: 0.75rem;
            color: var(--text-secondary);
        }

        /* Toast */
        .toast-container {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            z-index: 2000;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .toast {
            padding: 1rem 1.5rem;
            border-radius: 8px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            display: flex;
            align-items: center;
            gap: 0.75rem;
            animation: slideIn 0.3s ease;
        }

        .toast.success {
            border-color: var(--accent-green);
        }

        .toast.error {
            border-color: var(--accent-red);
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        /* Login Screen */
        .login-screen {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, var(--bg-primary) 0%, #1a1a2e 100%);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }

        .login-container {
            text-align: center;
            max-width: 480px;
            width: 90%;
        }

        .login-logo {
            font-size: 4rem;
            margin-bottom: 1rem;
            animation: float 3s ease-in-out infinite;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        .login-title {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 0.5rem;
        }

        .login-subtitle {
            color: var(--text-secondary);
            margin-bottom: 2rem;
            font-size: 1.1rem;
        }

        .login-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 2rem;
        }

        .login-card h2 {
            color: var(--text-primary);
            margin-bottom: 0.5rem;
            font-size: 1.3rem;
        }

        .login-card > p {
            color: var(--text-secondary);
            margin-bottom: 1.5rem;
        }

        .google-btn {
            width: 100%;
            padding: 0.875rem 1.5rem;
            background: #4285f4;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.75rem;
            transition: background 0.2s;
        }

        .google-btn:hover {
            background: #3367d6;
        }

        .google-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .google-btn svg {
            width: 20px;
            height: 20px;
        }

        .login-error {
            display: none;
            color: var(--accent-red);
            margin-top: 1rem;
            padding: 0.75rem;
            background: rgba(239, 68, 68, 0.1);
            border-radius: 8px;
            font-size: 0.9rem;
        }

        .login-security {
            margin-top: 1.5rem;
            text-align: center;
            color: var(--text-secondary);
            font-size: 0.85rem;
        }

        /* Subtasks in Modal */
        .subtasks-list {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            margin-bottom: 0.75rem;
            max-height: 200px;
            overflow-y: auto;
        }

        .subtask-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem;
            background: var(--bg-secondary);
            border-radius: 4px;
        }

        .subtask-item input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .subtask-item .subtask-title {
            flex: 1;
            font-size: 0.875rem;
        }

        .subtask-item .subtask-title.done {
            text-decoration: line-through;
            color: var(--text-secondary);
        }

        .subtask-item .subtask-delete {
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            padding: 0.25rem;
            font-size: 1rem;
            opacity: 0;
            transition: opacity 0.2s;
        }

        .subtask-item:hover .subtask-delete {
            opacity: 1;
        }

        .subtask-add, .comment-add {
            display: flex;
            gap: 0.5rem;
            align-items: flex-start;
        }

        .subtask-add input, .comment-add textarea {
            flex: 1;
        }

        /* Comments in Modal */
        .comments-list {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
            margin-bottom: 0.75rem;
            max-height: 200px;
            overflow-y: auto;
        }

        .comment-item {
            padding: 0.75rem;
            background: var(--bg-secondary);
            border-radius: 4px;
        }

        .comment-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.25rem;
        }

        .comment-author {
            font-weight: 500;
            font-size: 0.875rem;
        }

        .comment-time {
            font-size: 0.75rem;
            color: var(--text-secondary);
        }

        .comment-text {
            font-size: 0.875rem;
            color: var(--text-secondary);
        }

        /* Search */
        .search-container {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .search-input-wrapper {
            position: relative;
            display: inline-block;
        }

        .search-input {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 0.5rem 2rem 0.5rem 2.25rem;
            color: var(--text-primary);
            font-size: 0.875rem;
            width: 200px;
            transition: all 0.2s;
        }

        .search-input:focus {
            outline: none;
            border-color: var(--accent-blue);
            width: 280px;
        }

        .search-input::placeholder {
            color: var(--text-secondary);
        }

        .search-icon {
            position: absolute;
            left: 0.75rem;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-secondary);
            pointer-events: none;
        }

        .search-clear {
            position: absolute;
            right: 0.5rem;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            padding: 0.25rem;
            display: none;
            font-size: 1rem;
            line-height: 1;
        }

        .task-card.search-dimmed {
            opacity: 0.25;
            filter: grayscale(0.5);
            pointer-events: none;
        }

        /* Project items */
        .project-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px 12px;
            background: var(--bg-secondary);
            border-radius: 8px;
            margin-bottom: 8px;
        }

        .project-item .project-icon {
            font-size: 1.2rem;
        }

        .project-item .project-color {
            width: 16px;
            height: 16px;
            border-radius: 50%;
        }

        .project-item .project-name {
            flex: 1;
            font-weight: 500;
        }

        .tag-chip {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 4px 8px;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 16px;
            font-size: 0.8rem;
        }

        .tag-chip .tag-remove {
            cursor: pointer;
            opacity: 0.6;
            font-size: 0.9rem;
        }

        .tag-chip .tag-remove:hover {
            opacity: 1;
            color: #ef4444;
        }

        /* Mobile Responsive */
        @media (max-width: 768px) {
            .header {
                flex-direction: column;
                gap: 1rem;
                padding: 1rem;
            }

            .header-left {
                flex-direction: column;
                gap: 1rem;
                width: 100%;
            }

            .stats-bar {
                flex-wrap: wrap;
                gap: 1rem;
                padding: 1rem;
            }

            .main {
                flex-direction: column;
                height: auto;
            }

            .kanban {
                padding: 1rem;
                flex-direction: column;
            }

            .column {
                min-width: 100%;
                max-width: 100%;
            }

            .activity {
                width: 100%;
                border-left: none;
                border-top: 1px solid var(--border);
            }
        }

        /* Spinner */
        .spinner {
            width: 16px;
            height: 16px;
            border: 2px solid var(--border);
            border-top-color: var(--accent-blue);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Config warning */
        .config-warning {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid var(--accent-red);
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
            font-size: 0.9rem;
        }

        .config-warning code {
            background: var(--bg-primary);
            padding: 2px 6px;
            border-radius: 4px;
            font-family: monospace;
        }
    </style>
</head>
<body>
    <!-- Login Screen (shown when not authenticated) -->
    <div id="login-screen" class="login-screen">
        <div class="login-container">
            <div class="login-logo">üéØ</div>
            <h1 class="login-title">Mission Control</h1>
            <p class="login-subtitle">Firebase Edition - Real-time Task Management</p>

            <div class="login-card">
                <div id="config-warning" class="config-warning" style="display: none;">
                    ‚ö†Ô∏è <strong>Firebase not configured!</strong><br>
                    Edit the <code>firebaseConfig</code> object in this file to connect to your Firebase project.
                </div>
                
                <h2>üîê Sign In</h2>
                <p>Sign in with your Google account to sync tasks across devices.</p>

                <button class="google-btn" id="google-signin-btn" onclick="signInWithGoogle()">
                    <svg viewBox="0 0 24 24">
                        <path fill="currentColor" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                        <path fill="currentColor" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                        <path fill="currentColor" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                        <path fill="currentColor" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                    </svg>
                    Sign in with Google
                </button>

                <div id="login-error" class="login-error"></div>

                <p class="login-security">üîí Your data is stored securely in Firebase and syncs in real-time.</p>
            </div>
        </div>
    </div>

    <!-- Main Dashboard (hidden until authenticated) -->
    <div id="dashboard" class="dashboard" style="display: none;">
        <header class="header">
            <div class="header-left">
                <div class="logo">
                    <span>üéØ</span>
                    <span>Mission Control</span>
                </div>
                <nav class="nav-tabs">
                    <div class="nav-tab active" data-view="tasks" onclick="switchView('tasks')">Tasks</div>
                    <div class="nav-tab" data-view="projects" onclick="switchView('projects')">Projects</div>
                </nav>
                
                <!-- Search -->
                <div class="search-container">
                    <div class="search-input-wrapper">
                        <input type="text" 
                               id="search-input" 
                               class="search-input" 
                               placeholder="Search tasks..." 
                               oninput="handleSearch(this.value)"
                               onkeydown="if(event.key==='Escape'){clearSearch()}">
                        <svg class="search-icon" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="11" cy="11" r="8"></circle>
                            <path d="M21 21l-4.35-4.35"></path>
                        </svg>
                        <button class="search-clear" onclick="clearSearch()" title="Clear search">√ó</button>
                    </div>
                </div>
            </div>
            <div class="header-right">
                <span class="sync-indicator synced" id="sync-indicator">Synced</span>
                <button class="btn btn-secondary" onclick="refreshData()">‚Üª Refresh</button>

                <!-- User Profile (shown when logged in) -->
                <div class="user-profile" id="user-profile" style="display: none;">
                    <img class="user-avatar" id="user-avatar" src="" alt="Avatar">
                    <span class="user-name" id="user-name"></span>
                    <span class="user-logout" onclick="signOut()">Sign Out</span>
                </div>
            </div>
        </header>

        <!-- Tasks View -->
        <div id="view-tasks" class="view">
            <div class="stats-bar">
                <div class="stat">
                    <span class="stat-value" id="stat-week">0</span>
                    <span class="stat-label">In Review</span>
                </div>
                <div class="stat">
                    <span class="stat-value" id="stat-progress">0</span>
                    <span class="stat-label">In progress</span>
                </div>
                <div class="stat">
                    <span class="stat-value" id="stat-total">0</span>
                    <span class="stat-label">Total</span>
                </div>
                <div class="stat">
                    <span class="stat-value stat-highlight" id="stat-completion">0%</span>
                    <span class="stat-label">Completion</span>
                </div>
            </div>

            <div class="filters" id="filters">
                <button class="filter-btn active" data-filter="all">All projects</button>
            </div>

            <main class="main">
                <div class="kanban">
                    <div class="column">
                        <div class="column-header">
                            <div class="column-dot permanent"></div>
                            <span class="column-title">Permanent</span>
                            <span class="column-count" id="count-permanent">0</span>
                            <span class="column-add" onclick="openNewTask('permanent')" title="Add new task">+</span>
                        </div>
                        <div class="column-tasks" id="tasks-permanent" ondragover="handleDragOver(event)" ondragleave="handleDragLeave(event)" ondrop="handleDrop(event, 'permanent')"></div>
                    </div>

                    <div class="column">
                        <div class="column-header">
                            <div class="column-dot backlog"></div>
                            <span class="column-title">Backlog</span>
                            <span class="column-count" id="count-backlog">0</span>
                            <span class="column-add" onclick="openNewTask('backlog')" title="Add new task">+</span>
                        </div>
                        <div class="column-tasks" id="tasks-backlog" ondragover="handleDragOver(event)" ondragleave="handleDragLeave(event)" ondrop="handleDrop(event, 'backlog')"></div>
                    </div>

                    <div class="column">
                        <div class="column-header">
                            <div class="column-dot in-progress"></div>
                            <span class="column-title">In Progress</span>
                            <span class="column-count" id="count-in_progress">0</span>
                            <span class="column-add" onclick="openNewTask('in_progress')" title="Add new task">+</span>
                        </div>
                        <div class="column-tasks" id="tasks-in_progress" ondragover="handleDragOver(event)" ondragleave="handleDragLeave(event)" ondrop="handleDrop(event, 'in_progress')"></div>
                    </div>

                    <div class="column">
                        <div class="column-header">
                            <div class="column-dot review"></div>
                            <span class="column-title">Review</span>
                            <span class="column-count" id="count-review">0</span>
                            <span class="column-add" onclick="openNewTask('review')" title="Add new task">+</span>
                        </div>
                        <div class="column-tasks" id="tasks-review" ondragover="handleDragOver(event)" ondragleave="handleDragLeave(event)" ondrop="handleDrop(event, 'review')"></div>
                    </div>

                    <div class="column">
                        <div class="column-header">
                            <div class="column-dot done"></div>
                            <span class="column-title">Done</span>
                            <span class="column-count" id="count-done">0</span>
                        </div>
                        <div class="column-tasks" id="tasks-done" ondragover="handleDragOver(event)" ondragleave="handleDragLeave(event)" ondrop="handleDrop(event, 'done')"></div>
                    </div>
                </div>

                <aside class="activity" id="activity-sidebar">
                    <div class="activity-header">
                        <span>ACTIVITY</span>
                        <button class="activity-toggle" onclick="toggleActivity()">‚úï</button>
                    </div>
                    <div class="activity-list" id="activity-list"></div>
                </aside>
            </main>
        </div>

        <!-- Projects View -->
        <div id="view-projects" class="view" style="display: none;">
            <div style="max-width: 800px; margin: 0 auto; padding: 2rem;">
                <h2 style="margin-bottom: 1.5rem;">üìÅ Projects</h2>
                <div id="projects-list"></div>
                
                <div style="margin-top: 2rem; padding-top: 2rem; border-top: 1px solid var(--border);">
                    <h3 style="margin-bottom: 1rem;">Add New Project</h3>
                    <div style="display: grid; gap: 0.75rem;">
                        <input type="text" class="form-input" id="new-project-id" placeholder="ID (e.g., marketing)">
                        <input type="text" class="form-input" id="new-project-name" placeholder="Name (e.g., Marketing)">
                        <div style="display: flex; gap: 0.5rem; align-items: center;">
                            <input type="text" class="form-input" id="new-project-icon" placeholder="Icon (emoji)" style="width: 80px;">
                            <input type="color" id="new-project-color" value="#3b82f6" style="width: 50px; height: 38px; border: none; cursor: pointer; border-radius: 4px;">
                            <button class="btn btn-primary" onclick="saveProject()">+ Add Project</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Task Edit Modal -->
    <div class="modal-overlay" id="task-modal" onclick="if(event.target===this)hideTaskModal()">
        <div class="modal" style="max-width: 600px;">
            <div class="modal-header">
                <h2 class="modal-title" id="task-modal-title">Edit Task</h2>
                <button class="modal-close" onclick="hideTaskModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Title</label>
                    <input type="text" class="form-input" id="task-title" placeholder="Task title">
                </div>
                <div class="form-group">
                    <label class="form-label">Description</label>
                    <textarea class="form-input" id="task-description" rows="3" placeholder="Task description" style="resize: vertical;"></textarea>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                    <div class="form-group">
                        <label class="form-label">Status</label>
                        <select class="form-input" id="task-status">
                            <option value="permanent">Permanent</option>
                            <option value="backlog">Backlog</option>
                            <option value="in_progress">In Progress</option>
                            <option value="review">Review</option>
                            <option value="done">Done</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Priority</label>
                        <select class="form-input" id="task-priority">
                            <option value="low">Low</option>
                            <option value="medium">Medium</option>
                            <option value="high">High</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Project</label>
                    <select class="form-input" id="task-project"></select>
                </div>
                <div class="form-group">
                    <label class="form-label">Tags</label>
                    <div id="tags-chips" style="display: flex; flex-wrap: wrap; gap: 6px; margin-bottom: 8px;"></div>
                    <div style="display: flex; gap: 8px;">
                        <input type="text" class="form-input" id="new-tag-input" placeholder="Add tag..." style="flex: 1;" onkeydown="if(event.key==='Enter'){event.preventDefault();addTag();}">
                        <button class="btn btn-secondary btn-small" onclick="addTag()">+ Add</button>
                    </div>
                </div>

                <!-- Subtasks Section -->
                <div class="form-group">
                    <label class="form-label">Subtasks</label>
                    <div class="subtasks-list" id="subtasks-list"></div>
                    <div class="subtask-add">
                        <input type="text" class="form-input" id="new-subtask-input" placeholder="Add new subtask..." onkeydown="if(event.key==='Enter'){event.preventDefault();addSubtask();}">
                        <button class="btn btn-secondary btn-small" onclick="addSubtask()">+ Add</button>
                    </div>
                </div>

                <!-- Comments Section -->
                <div class="form-group">
                    <label class="form-label">Comments</label>
                    <div class="comments-list" id="comments-list"></div>
                    <div class="comment-add">
                        <textarea class="form-input" id="new-comment-input" rows="2" placeholder="Add a comment..."></textarea>
                        <button class="btn btn-secondary btn-small" onclick="addComment()">Post</button>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-danger" id="btn-delete-task" onclick="deleteTask()" style="margin-right: auto;">Delete</button>
                <button class="btn btn-secondary" onclick="hideTaskModal()">Cancel</button>
                <button class="btn btn-primary" onclick="saveTask()">Save Task</button>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div class="toast-container" id="toast-container"></div>

    <!-- Firebase SDK -->
    <script type="module">
        // =====================================================
        // FIREBASE CONFIGURATION - FILL THIS IN!
        // =====================================================
        // Get your config from Firebase Console:
        // 1. Go to https://console.firebase.google.com
        // 2. Create a project (or select existing)
        // 3. Add a web app
        // 4. Copy the config object
        // 5. Enable Authentication > Google provider
        // 6. Create Firestore database
        // =====================================================
        
        const firebaseConfig = {
            apiKey: "AIzaSyDioGaex5p_UTVX8D72b4EvEguwZuDXJkg",
            authDomain: "mission-control-munah.firebaseapp.com",
            projectId: "mission-control-munah",
            storageBucket: "mission-control-munah.firebasestorage.app",
            messagingSenderId: "106591320357",
            appId: "1:106591320357:web:a122792b9c75b8cb1542cc"
        };

        // Import Firebase modules from CDN
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { 
            getAuth, 
            signInWithPopup, 
            GoogleAuthProvider, 
            onAuthStateChanged,
            signOut as firebaseSignOut
        } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { 
            getFirestore, 
            collection, 
            doc, 
            getDocs, 
            getDoc,
            setDoc, 
            updateDoc,
            deleteDoc,
            onSnapshot,
            query,
            orderBy,
            enableIndexedDbPersistence
        } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        // Check if Firebase is configured
        const isConfigured = firebaseConfig.apiKey !== "YOUR_API_KEY";
        
        if (!isConfigured) {
            document.getElementById('config-warning').style.display = 'block';
            document.getElementById('google-signin-btn').disabled = true;
        }

        // Initialize Firebase
        let app, auth, db, provider;
        
        if (isConfigured) {
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
            provider = new GoogleAuthProvider();
            
            // Enable offline persistence
            enableIndexedDbPersistence(db).catch((err) => {
                if (err.code === 'failed-precondition') {
                    console.log('Persistence failed: Multiple tabs open');
                } else if (err.code === 'unimplemented') {
                    console.log('Persistence not available');
                }
            });
        }

        // === STATE ===
        window.STATE = {
            user: null,
            tasks: [],
            projects: [],
            activities: [],
            unsubscribeTasks: null,
            unsubscribeProjects: null,
            unsubscribeActivities: null
        };

        // Expose functions to window for onclick handlers
        window.signInWithGoogle = signInWithGoogle;
        window.signOut = signOutUser;
        window.refreshData = refreshData;
        window.openNewTask = openNewTask;
        window.openTaskDetail = openTaskDetail;
        window.hideTaskModal = hideTaskModal;
        window.saveTask = saveTask;
        window.deleteTask = deleteTask;
        window.addSubtask = addSubtask;
        window.toggleSubtask = toggleSubtask;
        window.deleteSubtask = deleteSubtask;
        window.addComment = addComment;
        window.addTag = addTag;
        window.removeTag = removeTag;
        window.saveProject = saveProject;
        window.deleteProject = deleteProject;
        window.switchView = switchView;
        window.filterByProject = filterByProject;
        window.handleSearch = handleSearch;
        window.clearSearch = clearSearch;
        window.toggleActivity = toggleActivity;
        window.handleDragStart = handleDragStart;
        window.handleDragEnd = handleDragEnd;
        window.handleDragOver = handleDragOver;
        window.handleDragLeave = handleDragLeave;
        window.handleDrop = handleDrop;
        window.quickMoveTask = quickMoveTask;

        // === AUTH FUNCTIONS ===
        async function signInWithGoogle() {
            if (!isConfigured) {
                showToast('error', 'Firebase not configured!');
                return;
            }
            
            try {
                const result = await signInWithPopup(auth, provider);
                console.log('Signed in:', result.user.displayName);
            } catch (error) {
                console.error('Sign in error:', error);
                const errorEl = document.getElementById('login-error');
                errorEl.textContent = error.message;
                errorEl.style.display = 'block';
            }
        }

        async function signOutUser() {
            try {
                // Unsubscribe from listeners
                if (STATE.unsubscribeTasks) STATE.unsubscribeTasks();
                if (STATE.unsubscribeProjects) STATE.unsubscribeProjects();
                if (STATE.unsubscribeActivities) STATE.unsubscribeActivities();
                
                await firebaseSignOut(auth);
                showToast('success', 'Signed out');
            } catch (error) {
                console.error('Sign out error:', error);
                showToast('error', 'Failed to sign out');
            }
        }

        // Listen for auth state changes
        if (isConfigured) {
            onAuthStateChanged(auth, (user) => {
                if (user) {
                    STATE.user = user;
                    updateAuthUI(user);
                    document.getElementById('login-screen').style.display = 'none';
                    document.getElementById('dashboard').style.display = 'block';
                    subscribeToData(user.uid);
                } else {
                    STATE.user = null;
                    document.getElementById('login-screen').style.display = 'flex';
                    document.getElementById('dashboard').style.display = 'none';
                }
            });
        }

        function updateAuthUI(user) {
            document.getElementById('user-profile').style.display = 'flex';
            document.getElementById('user-avatar').src = user.photoURL || '';
            document.getElementById('user-name').textContent = user.displayName || user.email;
        }

        // === DATA SUBSCRIPTION (REAL-TIME) ===
        function subscribeToData(userId) {
            // Subscribe to tasks
            const tasksRef = collection(db, `users/${userId}/tasks`);
            STATE.unsubscribeTasks = onSnapshot(tasksRef, (snapshot) => {
                STATE.tasks = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderTasks();
                updateStats();
                updateSyncIndicator('synced');
            }, (error) => {
                console.error('Tasks subscription error:', error);
                updateSyncIndicator('offline');
            });

            // Subscribe to projects
            const projectsRef = collection(db, `users/${userId}/projects`);
            STATE.unsubscribeProjects = onSnapshot(projectsRef, (snapshot) => {
                STATE.projects = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderFilters();
                renderProjectsList();
                updateProjectDropdown();
            });

            // Subscribe to activities
            const activitiesRef = collection(db, `users/${userId}/activities`);
            STATE.unsubscribeActivities = onSnapshot(query(activitiesRef, orderBy('timestamp', 'desc')), (snapshot) => {
                STATE.activities = snapshot.docs.slice(0, 20).map(doc => ({ id: doc.id, ...doc.data() }));
                renderActivity();
            });

            // Initialize with default projects if none exist
            getDocs(projectsRef).then((snapshot) => {
                if (snapshot.empty) {
                    initializeDefaultProjects(userId);
                }
            });
        }

        async function initializeDefaultProjects(userId) {
            const defaultProjects = [
                { id: 'work', name: 'Work', color: '#3b82f6', icon: 'üíº' },
                { id: 'personal', name: 'Personal', color: '#8b5cf6', icon: 'üè†' },
                { id: 'learning', name: 'Learning', color: '#f59e0b', icon: 'üìö' }
            ];

            for (const project of defaultProjects) {
                await setDoc(doc(db, `users/${userId}/projects`, project.id), project);
            }
        }

        function refreshData() {
            if (STATE.user) {
                updateSyncIndicator('syncing');
                // Real-time listeners auto-refresh, but we can force UI update
                renderTasks();
                updateStats();
                showToast('success', 'Refreshed!');
                setTimeout(() => updateSyncIndicator('synced'), 500);
            }
        }

        function updateSyncIndicator(status) {
            const indicator = document.getElementById('sync-indicator');
            indicator.className = 'sync-indicator ' + status;
            indicator.textContent = status === 'synced' ? 'Synced' : 
                                   status === 'syncing' ? 'Syncing...' : 'Offline';
        }

        // === RENDER FUNCTIONS ===
        let currentFilter = 'all';
        let searchQuery = '';

        function renderTasks() {
            const columns = ['permanent', 'backlog', 'in_progress', 'review', 'done'];
            const priorityOrder = { high: 0, medium: 1, low: 2 };

            columns.forEach(status => {
                const container = document.getElementById(`tasks-${status}`);
                let tasks = STATE.tasks.filter(t => t.status === status);

                // Apply project filter
                if (currentFilter !== 'all') {
                    tasks = tasks.filter(t => t.project === currentFilter);
                }

                // Sort by priority then by creation date
                tasks.sort((a, b) => {
                    const prioA = priorityOrder[a.priority] ?? 1;
                    const prioB = priorityOrder[b.priority] ?? 1;
                    if (prioA !== prioB) return prioA - prioB;
                    return (b.createdAt || 0) - (a.createdAt || 0);
                });

                const count = document.getElementById(`count-${status}`);
                count.textContent = tasks.length;
                
                container.innerHTML = tasks.length === 0
                    ? '<div class="empty-state">No tasks</div>'
                    : tasks.map(renderTaskCard).join('');
            });

            // Apply search filter if active
            if (searchQuery) {
                applySearchFilter();
            }
        }

        function renderTaskCard(task) {
            const subtasksDone = (task.subtasks || []).filter(s => s.done).length;
            const subtasksTotal = (task.subtasks || []).length;
            const progress = subtasksTotal > 0 ? Math.round((subtasksDone / subtasksTotal) * 100) : 0;
            const commentsCount = (task.comments || []).length;

            const reviewActions = task.status === 'review' ? `
                <div class="task-actions" onclick="event.stopPropagation()">
                    <button class="task-action-btn done" onclick="quickMoveTask('${task.id}', 'done')" title="Mark as Done">‚úì Done</button>
                    <button class="task-action-btn backlog" onclick="quickMoveTask('${task.id}', 'backlog')" title="Move to Backlog">‚Ü© Backlog</button>
                </div>
            ` : '';

            const commentIndicator = commentsCount > 0 ? `
                <div class="task-comment-indicator" title="${commentsCount} comment${commentsCount > 1 ? 's' : ''}">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
                    </svg>
                    <span>${commentsCount}</span>
                </div>
            ` : '';

            return `
                <div class="task-card priority-${task.priority}" data-task-id="${task.id}"
                     draggable="true"
                     ondragstart="handleDragStart(event, '${task.id}')"
                     ondragend="handleDragEnd(event)"
                     onclick="openTaskDetail('${task.id}')">
                    <div class="task-title">
                        <span class="task-title-text">${task.title}</span>
                    </div>
                    <div class="task-description">${task.description || ''}</div>
                    <div class="task-meta">
                        <div class="task-tags">
                            ${(task.tags || []).map(tag => `<span class="task-tag">${tag}</span>`).join('')}
                        </div>
                        ${commentIndicator}
                    </div>
                    ${subtasksTotal > 0 ? `
                        <div class="task-subtasks">
                            <div class="subtask-progress">
                                <span>${subtasksDone}/${subtasksTotal}</span>
                                <div class="progress-bar">
                                    <div class="progress-fill" style="width: ${progress}%"></div>
                                </div>
                                <span>${progress}%</span>
                            </div>
                        </div>
                    ` : ''}
                    ${reviewActions}
                </div>
            `;
        }

        async function quickMoveTask(taskId, newStatus) {
            if (!STATE.user) return;
            
            const task = STATE.tasks.find(t => t.id === taskId);
            if (!task) return;

            updateSyncIndicator('syncing');
            
            const updates = { status: newStatus };
            if (newStatus === 'done') {
                updates.completedAt = Date.now();
            }

            await updateDoc(doc(db, `users/${STATE.user.uid}/tasks`, taskId), updates);
            await addActivityLog('moved', task.title, newStatus);
        }

        function renderActivity() {
            const container = document.getElementById('activity-list');
            
            if (STATE.activities.length === 0) {
                container.innerHTML = '<div class="empty-state">No recent activity</div>';
                return;
            }

            container.innerHTML = STATE.activities.map(a => `
                <div class="activity-item">
                    <div class="activity-dot ${a.type}"></div>
                    <div class="activity-content">
                        <span class="activity-actor">${a.actor || 'You'}</span>
                        <span class="activity-action">${getActionText(a)}</span>
                        <span class="activity-task">${a.task}</span>
                        <div class="activity-time">${formatTimeAgo(a.timestamp)}</div>
                    </div>
                </div>
            `).join('');
        }

        function getActionText(activity) {
            switch(activity.type) {
                case 'created': return ' created ';
                case 'moved': return ` moved to ${activity.to} `;
                case 'completed': return ' completed ';
                case 'deleted': return ' deleted ';
                default: return ' updated ';
            }
        }

        function formatTimeAgo(timestamp) {
            if (!timestamp) return '';
            const date = new Date(timestamp);
            const now = new Date();
            const diffMs = now - date;
            const diffMin = Math.floor(diffMs / 60000);
            const diffHour = Math.floor(diffMs / 3600000);
            const diffDay = Math.floor(diffMs / 86400000);

            if (diffMin < 1) return 'just now';
            if (diffMin < 60) return diffMin + ' min ago';
            if (diffHour < 24) return diffHour + ' hours ago';
            return diffDay + ' days ago';
        }

        async function addActivityLog(type, taskName, to = null) {
            if (!STATE.user) return;
            
            const activity = {
                type,
                task: taskName,
                actor: STATE.user.displayName || 'You',
                timestamp: Date.now()
            };
            if (to) activity.to = to;

            await setDoc(doc(collection(db, `users/${STATE.user.uid}/activities`)), activity);
        }

        function renderFilters() {
            const container = document.getElementById('filters');
            const projectButtons = STATE.projects.map(p =>
                `<button class="filter-btn" data-filter="${p.id}" onclick="filterByProject('${p.id}')">${p.icon} ${p.name}</button>`
            ).join('');
            container.innerHTML = `
                <button class="filter-btn active" data-filter="all" onclick="filterByProject('all')">All projects</button>
                ${projectButtons}
            `;
        }

        function filterByProject(projectId) {
            currentFilter = projectId;
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.filter === projectId);
            });
            renderTasks();
        }

        function updateStats() {
            const total = STATE.tasks.filter(t => t.status !== 'permanent').length;
            const inProgress = STATE.tasks.filter(t => t.status === 'in_progress').length;
            const review = STATE.tasks.filter(t => t.status === 'review').length;
            const done = STATE.tasks.filter(t => t.status === 'done').length;
            const completion = total > 0 ? Math.round((done / total) * 100) : 0;

            document.getElementById('stat-total').textContent = total;
            document.getElementById('stat-progress').textContent = inProgress;
            document.getElementById('stat-week').textContent = review;
            document.getElementById('stat-completion').textContent = completion + '%';
        }

        // === TASK EDITING ===
        let currentEditingTaskId = null;
        let currentTaskTags = [];

        function openNewTask(status = 'backlog') {
            if (!STATE.user) {
                showToast('error', 'Please sign in first');
                return;
            }

            currentEditingTaskId = null;
            currentTaskTags = [];

            document.getElementById('task-modal-title').textContent = 'New Task';
            document.getElementById('task-title').value = '';
            document.getElementById('task-description').value = '';
            document.getElementById('task-status').value = status;
            document.getElementById('task-priority').value = 'medium';
            document.getElementById('task-project').value = STATE.projects[0]?.id || '';
            document.getElementById('btn-delete-task').style.display = 'none';

            renderTagChips();
            document.getElementById('subtasks-list').innerHTML = '<div style="color: var(--text-secondary); font-size: 0.875rem;">No subtasks yet</div>';
            document.getElementById('comments-list').innerHTML = '<div style="color: var(--text-secondary); font-size: 0.875rem;">No comments yet</div>';

            document.getElementById('task-modal').classList.add('visible');
        }

        function openTaskDetail(taskId) {
            if (!STATE.user) {
                showToast('error', 'Please sign in first');
                return;
            }

            const task = STATE.tasks.find(t => t.id === taskId);
            if (!task) {
                showToast('error', 'Task not found');
                return;
            }

            currentEditingTaskId = taskId;
            currentTaskTags = [...(task.tags || [])];

            document.getElementById('task-modal-title').textContent = 'Edit Task';
            document.getElementById('task-title').value = task.title;
            document.getElementById('task-description').value = task.description || '';
            document.getElementById('task-status').value = task.status;
            document.getElementById('task-priority').value = task.priority;
            document.getElementById('task-project').value = task.project || '';
            document.getElementById('btn-delete-task').style.display = 'block';

            renderTagChips();
            renderSubtasks(task);
            renderComments(task);

            document.getElementById('task-modal').classList.add('visible');
        }

        function hideTaskModal() {
            document.getElementById('task-modal').classList.remove('visible');
            currentEditingTaskId = null;
        }

        async function saveTask() {
            if (!STATE.user) return;

            const title = document.getElementById('task-title').value.trim();
            const description = document.getElementById('task-description').value.trim();
            const status = document.getElementById('task-status').value;
            const priority = document.getElementById('task-priority').value;
            const project = document.getElementById('task-project').value;

            if (!title) {
                showToast('error', 'Title is required');
                return;
            }

            updateSyncIndicator('syncing');

            const taskData = {
                title,
                description,
                status,
                priority,
                project,
                tags: currentTaskTags,
                updatedAt: Date.now()
            };

            try {
                if (currentEditingTaskId) {
                    // Update existing task
                    const existingTask = STATE.tasks.find(t => t.id === currentEditingTaskId);
                    taskData.subtasks = existingTask?.subtasks || [];
                    taskData.comments = existingTask?.comments || [];
                    await updateDoc(doc(db, `users/${STATE.user.uid}/tasks`, currentEditingTaskId), taskData);
                } else {
                    // Create new task
                    taskData.createdAt = Date.now();
                    taskData.subtasks = [];
                    taskData.comments = [];
                    const newId = 'task_' + Date.now();
                    await setDoc(doc(db, `users/${STATE.user.uid}/tasks`, newId), taskData);
                    await addActivityLog('created', title);
                }

                hideTaskModal();
                showToast('success', 'Task saved!');
            } catch (error) {
                console.error('Error saving task:', error);
                showToast('error', 'Failed to save task');
            }
        }

        async function deleteTask() {
            if (!currentEditingTaskId || !STATE.user) return;

            if (!confirm('Are you sure you want to delete this task?')) return;

            const task = STATE.tasks.find(t => t.id === currentEditingTaskId);

            try {
                await deleteDoc(doc(db, `users/${STATE.user.uid}/tasks`, currentEditingTaskId));
                await addActivityLog('deleted', task?.title || 'Task');
                hideTaskModal();
                showToast('success', 'Task deleted');
            } catch (error) {
                console.error('Error deleting task:', error);
                showToast('error', 'Failed to delete task');
            }
        }

        // === SUBTASKS ===
        function renderSubtasks(task) {
            const container = document.getElementById('subtasks-list');
            const subtasks = task.subtasks || [];
            
            if (subtasks.length === 0) {
                container.innerHTML = '<div style="color: var(--text-secondary); font-size: 0.875rem;">No subtasks yet</div>';
                return;
            }

            container.innerHTML = subtasks.map((sub, idx) => `
                <div class="subtask-item">
                    <input type="checkbox" ${sub.done ? 'checked' : ''} onchange="toggleSubtask(${idx})">
                    <span class="subtask-title ${sub.done ? 'done' : ''}">${sub.title}</span>
                    <button class="subtask-delete" onclick="deleteSubtask(${idx})" title="Delete">‚úï</button>
                </div>
            `).join('');
        }

        async function addSubtask() {
            if (!currentEditingTaskId || !STATE.user) return;
            
            const input = document.getElementById('new-subtask-input');
            const title = input.value.trim();
            if (!title) return;

            const task = STATE.tasks.find(t => t.id === currentEditingTaskId);
            if (!task) return;

            const subtasks = [...(task.subtasks || []), { title, done: false }];
            
            await updateDoc(doc(db, `users/${STATE.user.uid}/tasks`, currentEditingTaskId), { subtasks });
            input.value = '';
        }

        async function toggleSubtask(index) {
            if (!currentEditingTaskId || !STATE.user) return;

            const task = STATE.tasks.find(t => t.id === currentEditingTaskId);
            if (!task || !task.subtasks) return;

            const subtasks = [...task.subtasks];
            subtasks[index].done = !subtasks[index].done;
            
            await updateDoc(doc(db, `users/${STATE.user.uid}/tasks`, currentEditingTaskId), { subtasks });
        }

        async function deleteSubtask(index) {
            if (!currentEditingTaskId || !STATE.user) return;

            const task = STATE.tasks.find(t => t.id === currentEditingTaskId);
            if (!task || !task.subtasks) return;

            const subtasks = task.subtasks.filter((_, i) => i !== index);
            
            await updateDoc(doc(db, `users/${STATE.user.uid}/tasks`, currentEditingTaskId), { subtasks });
        }

        // === COMMENTS ===
        function renderComments(task) {
            const container = document.getElementById('comments-list');
            const comments = task.comments || [];
            
            if (comments.length === 0) {
                container.innerHTML = '<div style="color: var(--text-secondary); font-size: 0.875rem;">No comments yet</div>';
                return;
            }

            container.innerHTML = comments.map(c => `
                <div class="comment-item">
                    <div class="comment-header">
                        <span class="comment-author">${c.author}</span>
                        <span class="comment-time">${formatTimeAgo(c.timestamp)}</span>
                    </div>
                    <div class="comment-text">${c.text}</div>
                </div>
            `).join('');
        }

        async function addComment() {
            if (!currentEditingTaskId || !STATE.user) return;
            
            const input = document.getElementById('new-comment-input');
            const text = input.value.trim();
            if (!text) return;

            const task = STATE.tasks.find(t => t.id === currentEditingTaskId);
            if (!task) return;

            const comments = [...(task.comments || []), {
                author: STATE.user.displayName || 'You',
                text,
                timestamp: Date.now()
            }];
            
            await updateDoc(doc(db, `users/${STATE.user.uid}/tasks`, currentEditingTaskId), { comments });
            input.value = '';
        }

        // === TAGS ===
        function renderTagChips() {
            const container = document.getElementById('tags-chips');
            if (currentTaskTags.length === 0) {
                container.innerHTML = '<span style="color: var(--text-secondary); font-size: 0.875rem;">No tags</span>';
                return;
            }
            container.innerHTML = currentTaskTags.map(tag => `
                <span class="tag-chip">
                    ${tag}
                    <span class="tag-remove" onclick="removeTag('${tag}')" title="Remove">‚úï</span>
                </span>
            `).join('');
        }

        function addTag() {
            const input = document.getElementById('new-tag-input');
            const tag = input.value.trim().toLowerCase();
            if (!tag) return;

            if (!currentTaskTags.includes(tag)) {
                currentTaskTags.push(tag);
                renderTagChips();
            }
            input.value = '';
        }

        function removeTag(tag) {
            currentTaskTags = currentTaskTags.filter(t => t !== tag);
            renderTagChips();
        }

        // === PROJECTS ===
        function renderProjectsList() {
            const container = document.getElementById('projects-list');
            if (STATE.projects.length === 0) {
                container.innerHTML = '<div class="empty-state">No projects yet</div>';
                return;
            }

            container.innerHTML = STATE.projects.map(p => `
                <div class="project-item">
                    <span class="project-icon">${p.icon}</span>
                    <span class="project-color" style="background: ${p.color}"></span>
                    <span class="project-name">${p.name}</span>
                    <button class="btn btn-small btn-secondary" onclick="deleteProject('${p.id}')">Delete</button>
                </div>
            `).join('');
        }

        function updateProjectDropdown() {
            const select = document.getElementById('task-project');
            if (!select) return;
            select.innerHTML = STATE.projects.map(p =>
                `<option value="${p.id}">${p.icon} ${p.name}</option>`
            ).join('');
        }

        async function saveProject() {
            if (!STATE.user) return;

            const id = document.getElementById('new-project-id').value.trim().toLowerCase().replace(/\s+/g, '-');
            const name = document.getElementById('new-project-name').value.trim();
            const icon = document.getElementById('new-project-icon').value.trim() || 'üìÅ';
            const color = document.getElementById('new-project-color').value;

            if (!id || !name) {
                showToast('error', 'ID and Name are required');
                return;
            }

            try {
                await setDoc(doc(db, `users/${STATE.user.uid}/projects`, id), { id, name, icon, color });
                document.getElementById('new-project-id').value = '';
                document.getElementById('new-project-name').value = '';
                document.getElementById('new-project-icon').value = '';
                showToast('success', 'Project added!');
            } catch (error) {
                console.error('Error saving project:', error);
                showToast('error', 'Failed to save project');
            }
        }

        async function deleteProject(projectId) {
            if (!STATE.user) return;
            if (!confirm('Delete this project?')) return;

            try {
                await deleteDoc(doc(db, `users/${STATE.user.uid}/projects`, projectId));
                showToast('success', 'Project deleted');
            } catch (error) {
                console.error('Error deleting project:', error);
                showToast('error', 'Failed to delete project');
            }
        }

        // === DRAG & DROP ===
        let draggedTaskId = null;
        let dropTargetInfo = null;

        function handleDragStart(event, taskId) {
            draggedTaskId = taskId;
            event.target.classList.add('dragging');
            event.dataTransfer.effectAllowed = 'move';
            event.dataTransfer.setData('text/plain', taskId);
        }

        function handleDragEnd(event) {
            event.target.classList.remove('dragging');
            document.querySelectorAll('.task-card').forEach(card => {
                card.classList.remove('make-space-above');
            });
            document.querySelectorAll('.column-tasks').forEach(col => {
                col.classList.remove('drag-over');
            });
            draggedTaskId = null;
            dropTargetInfo = null;
        }

        function handleDragOver(event) {
            event.preventDefault();
            event.dataTransfer.dropEffect = 'move';

            const container = event.currentTarget;
            document.querySelectorAll('.column-tasks').forEach(col => {
                if (col !== container) col.classList.remove('drag-over');
            });
            container.classList.add('drag-over');

            // Find insert position
            const cards = [...container.querySelectorAll('.task-card:not(.dragging)')];
            const mouseY = event.clientY;

            cards.forEach(card => card.classList.remove('make-space-above'));

            for (const card of cards) {
                const rect = card.getBoundingClientRect();
                if (mouseY < rect.top + rect.height / 2) {
                    card.classList.add('make-space-above');
                    break;
                }
            }
        }

        function handleDragLeave(event) {
            const rect = event.currentTarget.getBoundingClientRect();
            const x = event.clientX;
            const y = event.clientY;

            if (x < rect.left || x > rect.right || y < rect.top || y > rect.bottom) {
                event.currentTarget.classList.remove('drag-over');
                event.currentTarget.querySelectorAll('.task-card').forEach(card => {
                    card.classList.remove('make-space-above');
                });
            }
        }

        async function handleDrop(event, newStatus) {
            event.preventDefault();
            event.currentTarget.classList.remove('drag-over');
            document.querySelectorAll('.task-card').forEach(card => {
                card.classList.remove('make-space-above');
            });

            if (!draggedTaskId || !STATE.user) return;

            const task = STATE.tasks.find(t => t.id === draggedTaskId);
            if (!task || task.status === newStatus) return;

            updateSyncIndicator('syncing');

            const updates = { status: newStatus };
            if (newStatus === 'done') {
                updates.completedAt = Date.now();
            }

            await updateDoc(doc(db, `users/${STATE.user.uid}/tasks`, draggedTaskId), updates);
            await addActivityLog('moved', task.title, newStatus);
        }

        // === SEARCH ===
        function handleSearch(query) {
            searchQuery = query.toLowerCase().trim();
            applySearchFilter();
        }

        function applySearchFilter() {
            const cards = document.querySelectorAll('.task-card');
            
            cards.forEach(card => {
                const taskId = card.getAttribute('data-task-id');
                const task = STATE.tasks.find(t => t.id === taskId);
                
                if (!task || !searchQuery) {
                    card.classList.remove('search-dimmed');
                    return;
                }
                
                const titleMatch = task.title.toLowerCase().includes(searchQuery);
                const descMatch = (task.description || '').toLowerCase().includes(searchQuery);
                const tagMatch = (task.tags || []).some(tag => tag.toLowerCase().includes(searchQuery));
                
                if (titleMatch || descMatch || tagMatch) {
                    card.classList.remove('search-dimmed');
                } else {
                    card.classList.add('search-dimmed');
                }
            });
        }

        function clearSearch() {
            const input = document.getElementById('search-input');
            if (input) {
                input.value = '';
            }
            searchQuery = '';
            applySearchFilter();
        }

        // === VIEW SWITCHING ===
        function switchView(viewName) {
            document.querySelectorAll('.view').forEach(v => v.style.display = 'none');
            document.getElementById('view-' + viewName).style.display = 'block';
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.toggle('active', tab.dataset.view === viewName);
            });
        }

        // === ACTIVITY TOGGLE ===
        function toggleActivity() {
            const sidebar = document.getElementById('activity-sidebar');
            sidebar.classList.toggle('collapsed');
        }

        // === TOAST ===
        function showToast(type, message) {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.innerHTML = `
                <span>${type === 'success' ? '‚úì' : '‚úó'}</span>
                <span>${message}</span>
            `;
            container.appendChild(toast);

            setTimeout(() => {
                toast.remove();
            }, 3000);
        }

        // Make showToast available globally
        window.showToast = showToast;
    </script>
</body>
</html>
